name: Build, Test, and Deploy Continuous Release

on:
  push:
    branches:
      - main
      - dev

jobs:
  # ------------------------------------------------------------------
  # JOB 1: SECURITY AUDIT
  # ------------------------------------------------------------------
  security-audit:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install pytest hypothesis bandit safety radon psutil anyio pip-audit
      - run: bandit -r src -c bandit.yaml -ll
      - run: pip-audit
      - run: radon cc src -n F -a
      - run: |
          wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.4_linux_x64.tar.gz
          ./gitleaks detect --source . --verbose --exit-code 1
      - uses: github/codeql-action/init@v4
        with:
          languages: python
      - uses: github/codeql-action/autobuild@v4
      - uses: github/codeql-action/analyze@v4
      - run: |
          pip install -r requirements.in
          export PYTHONPATH="${{ github.workspace }}:$PYTHONPATH"
          pytest tests/

  # ------------------------------------------------------------------
  # JOB 2: BUILD & DEPLOY (Clean Titles & Filenames)
  # ------------------------------------------------------------------
  build-and-deploy:
    needs: security-audit
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: 1. Checkout
        uses: actions/checkout@v4

      - name: 2. Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: 3. Install Dependencies
        run: |
          pip install -r requirements.in
          pip install pyinstaller==6.16.0 pywin32==306

      - name: 4. Setup Inno Setup
        shell: powershell
        run: echo "C:\Program Files (x86)\Inno Setup 6" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: 5. Download Languages
        shell: powershell
        run: |
          $langDir = "C:\Program Files (x86)\Inno Setup 6\Languages"
          $baseUrl = "https://raw.githubusercontent.com/jrsoftware/issrc/main/Files/Languages/"
          $languages = "Arabic.isl", "German.isl", "Spanish.isl", "French.isl", "Japanese.isl", "Korean.isl", "Russian.isl", "Turkish.isl"
          foreach ($lang in $languages) { Invoke-WebRequest "$baseUrl$lang" -OutFile "$langDir\$lang" }

      # --- INTERNAL VERSIONING (Hidden from User Filename) ---
      - name: 6. Inject Version Info (Internal)
        shell: powershell
        run: |
          $hash = "${{ github.sha }}".Substring(0, 8)
          $fileContent = "COMMIT_HASH = '$hash'"
          Set-Content -Path "src/version_info.py" -Value $fileContent

      # --- EXTERNAL NAMING (Clean & Professional) ---
      - name: 7. Set Clean Filenames
        shell: powershell
        run: |
          # We force a clean name regardless of the hash
          if ("${{ github.ref_name }}" -eq "dev") {
            echo "RELEASE_TAG=dev-latest" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            # Clean Name for Dev:
            echo "SETUP_FILENAME=KaspaGateway_Dev_Setup" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          } else {
            echo "RELEASE_TAG=v1.0.0" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            # Clean Name for Production:
            echo "SETUP_FILENAME=KaspaGateway_Setup" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          }

      - name: 8. Run PyInstaller
        run: pyinstaller KaspaGateway.spec --clean --noconfirm

      - name: 9. Run Inno Setup
        run: iscc ".\installer_script.iss" /DSetupFilename=${{ env.SETUP_FILENAME }}

      - name: 10. Calculate SHA256
        shell: powershell
        run: |
          $filePath = "dist\${{ env.SETUP_FILENAME }}.exe"
          $hashPath = "$filePath.sha256"
          Get-FileHash -Algorithm SHA256 $filePath | Select-Object -ExpandProperty Hash | Set-Content $hashPath

      - name: 11. Publish Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: powershell
        run: |
          $files = "dist\${{ env.SETUP_FILENAME }}.exe", "dist\${{ env.SETUP_FILENAME }}.exe.sha256"
          $tag = "${{ env.RELEASE_TAG }}"
          
          # Delete old release to keep it clean
          try { gh release delete $tag --yes --cleanup-tag } catch {}

          if ("${{ github.ref_name }}" -eq "dev") {
            # Cleaner Title for Dev Build (No Hash in Title)
            gh release create $tag $files --title "KaspaGateway Development Build" --notes "Latest automated build from dev branch.`nCommit: ${{ github.sha }}" --prerelease
          } else {
            # Cleaner Title for Stable Build
            gh release create $tag $files --title "KaspaGateway v1.0.0" --notes "Official Stable Release."
          }